version: "3"
services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: incident-command-frontend
    ports:
      - "3000:80"
    networks:
      - dd_net
      
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: incident-command-backend
    ports:
      - "8080:8080"
    environment:
      - CGO_ENABLED=1
      - PKG_CONFIG_PATH=/usr/lib/pkgconfig
    env_file:
      - .env
    volumes:
      - ./backend/firebase-service-account.json:/root/backend/firebase-service-account.json:ro
    networks:
      - dd_net
      
  logs_agent:
    build:
      context: ./agents
      dockerfile: specialized_agents/logs_traces_agent/Dockerfile
    container_name: logs-agent
    working_dir: /app/agents/specialized_agents/logs_traces_agent
    volumes:
      - ./agents/specialized_agents/logs_traces_agent/outputs:/app/agents/specialized_agents/logs_traces_agent/outputs
      - ./backend/firebase-service-account.json:/app/backend/firebase-service-account.json:ro
    env_file:
      - .env
    environment:
      - DD_MAX_CONCURRENT=1
      - CLIENT_PROPERTIES_PATH=/app/common/client.properties
      - FIREBASE_CREDENTIALS_PATH=/app/backend/firebase-service-account.json
      - GOOGLE_APPLICATION_CREDENTIALS=/app/backend/firebase-service-account.json
    restart: unless-stopped
    networks:
      - dd_net
      
  metrics-agent:
    build:
      context: ./agents
      dockerfile: specialized_agents/metrics_agent/Dockerfile
    container_name: metrics-agent
    working_dir: /app/agents/specialized_agents/metrics_agent
    volumes:
      - ./agents/specialized_agents/metrics_agent/outputs:/app/agents/specialized_agents/metrics_agent/outputs
      - ./backend/firebase-service-account.json:/app/backend/firebase-service-account.json:ro
    env_file:
      - .env
    environment:
      - CLIENT_PROPERTIES_PATH=/app/common/client.properties
      - FIREBASE_CREDENTIALS_PATH=/app/backend/firebase-service-account.json
      - GOOGLE_APPLICATION_CREDENTIALS=/app/backend/firebase-service-account.json
      - DD_MAX_CONCURRENT=1
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL}
      - FIREBASE_WEB_API_KEY=${FIREBASE_WEB_API_KEY}
    restart: unless-stopped
    depends_on:
      - logs_agent
    networks:
      - dd_net
        
  moderator-agent:
    build:
      context: ./agents
      dockerfile: specialized_agents/moderator_agent/Dockerfile
    container_name: moderator-agent
    working_dir: /app
    volumes:
      - ./agents/specialized_agents/moderator_agent/outputs:/app/agents/specialized_agents/moderator_agent/outputs
      - ./backend/firebase-service-account.json:/app/backend/firebase-service-account.json:ro
    env_file:
      - .env
    environment:
      - EXPECTED_AGENTS=logs_traces_agent,rca_historical_agent,metrics_agent
      - CLIENT_PROPERTIES_PATH=/app/common/client.properties
      - FIREBASE_CREDENTIALS_PATH=/app/backend/firebase-service-account.json
      - GOOGLE_APPLICATION_CREDENTIALS=/app/backend/firebase-service-account.json
    restart: unless-stopped
    depends_on:
      - logs_agent
    networks:
      - dd_net
      
  rca_historical_agent:
    build:
      context: ./agents
      dockerfile: specialized_agents/rca_historical_agent/Dockerfile
    container_name: rca-historical-agent
    working_dir: /app/agents/specialized_agents/rca_historical_agent
    volumes:
      - ./agents/specialized_agents/rca_historical_agent/outputs:/app/agents/specialized_agents/rca_historical_agent/outputs
      - ./backend/firebase-service-account.json:/app/backend/firebase-service-account.json:ro
    env_file:
      - .env
    environment:
      - CLIENT_PROPERTIES_PATH=/app/common/client.properties
      - FIREBASE_CREDENTIALS_PATH=/app/backend/firebase-service-account.json
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/backend/firebase-service-account.json
    restart: unless-stopped
    depends_on:
      - logs_agent
    networks:
      - dd_net
      
networks:
  dd_net:
    driver: bridge